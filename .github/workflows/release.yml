name: Release R Package

on:
    push:
        tags:
            - "v*"

jobs:
    release:
        name: Build and Release
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4

            - uses: r-lib/actions/setup-r@v2
              with:
                  use-public-rspm: true

            # We need dependencies to successfully build the package (vignettes, etc.)
            - uses: r-lib/actions/setup-r-dependencies@v2
              with:
                  extra-packages: any::pkgbuild

            - name: Build Package
              run: |
                  # builds the package as a tar.gz in the current directory
                  pkgbuild::build(dest_path = ".", binary = FALSE, vignettes = TRUE)
              shell: Rscript {0}

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  # This automatically picks up the tag that triggered the workflow
                  files: |
                      *.tar.gz
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
